<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convivencia Escolar Pro - Gestión Integral</title>
    
    <!-- 1. Estilos y Fuentes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f0f4f8; color: #1e293b; }
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.75); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 100; padding: 1rem; }
        .spinner { width: 40px; height: 40px; border: 3px solid #e2e8f0; border-top: 3px solid #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* UI Kit */
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .gradient-sidebar { background: linear-gradient(180deg, #312e81 0%, #4338ca 100%); }
        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        
        .badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700; font-size: 0.75rem; letter-spacing: 0.025em; text-transform: uppercase; }
        .badge-pending { background-color: #fef3c7; color: #b45309; }
        .badge-active { background-color: #dbeafe; color: #1e40af; }
        .badge-pie { background-color: #e0e7ff; color: #4338ca; }
        .badge-closed { background-color: #d1fae5; color: #047857; }
        
        .input-locked { background-color: #f1f5f9; border-color: #cbd5e1; color: #64748b; cursor: not-allowed; }
    </style>

    <!-- 2. Librerías -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- 3. Firebase Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="root">
        <div style="height:100vh; display:flex; justify-content:center; align-items:center; flex-direction:column; background: #f8fafc;">
            <div class="spinner"></div>
            <p style="margin-top:20px; color:#475569; font-weight:600; font-size: 0.9rem;">Cargando Plataforma...</p>
        </div>
    </div>

    <script type="text/babel">
        // --- CONFIGURACIÓN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCoWGztkjAUapy4BuMHRjgmUvLEyO5JI4U",
            authDomain: "gestor-convivencia-escolar.firebaseapp.com",
            projectId: "gestor-convivencia-escolar",
            storageBucket: "gestor-convivencia-escolar.firebasestorage.app",
            messagingSenderId: "864079766812",
            appId: "1:864079766812:web:abdf1eb0da71b1a3aec6d9"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const { useState, useEffect, useMemo } = React;

        // --- UTILS ---
        const Icon = ({ name, size = 18, className = "", onClick }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className} onClick={onClick}></i>;
        };

        const generateNarrative = (c) => {
            const dateStr = new Date(c.date).toLocaleDateString();
            let text = `Con fecha ${dateStr}, se registra una situación asociada al estudiante ${c.studentName} del curso ${c.course}. `;
            const context = [];
            if(c.isPIE) context.push("perteneciente al Programa de Integración Escolar (PIE)");
            if(c.hasExternalSupport) context.push("con apoyo de redes externas");
            if(context.length > 0) text += `El estudiante es ${context.join(' y ')}. `;

            if (c.isReferral) {
                text += `El caso fue derivado por ${c.senderName} (${c.senderJob}), reportando una situación de ${c.cause || 'carácter general'}. `;
                text += `En el reporte inicial se describe: "${c.description}". `;
            } else {
                text += `Se tipificó el caso como "${c.type}". `;
                text += `Descripción del evento: "${c.description}". `;
            }
            if (c.status === 'Cerrado') text += `Actualmente el caso se encuentra CERRADO. `;
            else text += `El caso se mantiene ABIERTO y en seguimiento. `;
            
            return text;
        };

        const generatePDF = (title, data, type, extraInfo = "", managerName = "Encargado") => {
            if(!window.jspdf) return alert("Error: Librería PDF no cargada.");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.width;
            
            doc.setFillColor(49, 46, 129); doc.rect(0, 0, pageWidth, 40, 'F');
            doc.setFillColor(67, 56, 202); doc.circle(20, 20, 12, 'F'); 
            doc.setTextColor(255, 255, 255); doc.setFontSize(22); doc.setFont(undefined, 'bold'); doc.text("INFORME DE CONVIVENCIA", 40, 22);
            doc.setFontSize(10); doc.setFont(undefined, 'normal'); doc.text("Sistema de Gestión Escolar Integral", 40, 28);
            doc.text(`Fecha Emisión: ${new Date().toLocaleDateString()}`, pageWidth - 15, 22, { align: 'right' });
            doc.text(`Ref: ${title}`, pageWidth - 15, 28, { align: 'right' });

            doc.setTextColor(30, 41, 59);
            let y = 55;

            if (type === 'single' || type === 'referral_single') {
                const c = data;
                doc.setFontSize(14); doc.setFont(undefined, 'bold'); doc.setTextColor(79, 70, 229);
                doc.text(c.studentName.toUpperCase(), 15, y);
                doc.setFontSize(10); doc.setTextColor(100); doc.text(c.course, 15, y + 6);
                
                const statusColor = c.status === 'Cerrado' ? [16, 185, 129] : [245, 158, 11];
                doc.setFillColor(...statusColor); doc.roundedRect(pageWidth - 45, y - 5, 30, 8, 2, 2, 'F');
                doc.setTextColor(255); doc.setFontSize(8); doc.setFont(undefined, 'bold');
                doc.text((c.status || 'ABIERTO').toUpperCase(), pageWidth - 30, y, { align: 'center' });
                y += 20;

                const keyData = [
                    ['Fecha Evento', new Date(c.date).toLocaleDateString(), 'Tipificación', c.type || c.cause || 'N/A'], 
                    ['Estudiante PIE', c.isPIE ? 'SÍ' : 'NO', 'Redes Externas', c.hasExternalSupport ? 'SÍ' : 'NO'], 
                    ['Profesional', c.professional || 'Por asignar', 'Solicitante', c.senderName || 'Ingreso Directo']
                ];
                doc.autoTable({ startY: y, head: [], body: keyData, theme: 'grid', styles: { fontSize: 9, cellPadding: 3 }, columnStyles: { 0: { fontStyle: 'bold', fillColor: [241, 245, 249] }, 2: { fontStyle: 'bold', fillColor: [241, 245, 249] } } });
                y = doc.lastAutoTable.finalY + 10;

                doc.setFontSize(11); doc.setFont(undefined, 'bold'); doc.setTextColor(30); doc.text("ANÁLISIS DE LA SITUACIÓN", 15, y); y += 6;
                doc.setFont(undefined, 'normal'); doc.setFontSize(10);
                const narrative = generateNarrative(c);
                const splitText = doc.splitTextToSize(narrative, pageWidth - 30);
                doc.text(splitText, 15, y); y += (splitText.length * 5) + 10;

                if (c.interventions && c.interventions.length > 0) {
                    doc.setFontSize(11); doc.setFont(undefined, 'bold'); doc.text("BITÁCORA DE GESTIÓN Y ACUERDOS", 15, y); y += 5;
                    const logBody = c.interventions.map(i => [
                        new Date(i.date).toLocaleDateString(), 
                        i.professional || 'Sistema', 
                        i.content + (i.actions && i.actions.length > 0 ? `\n[Acciones: ${i.actions.join(', ')}]` : '')
                    ]);
                    doc.autoTable({ startY: y, head: [['Fecha', 'Resp.', 'Gestión / Acciones']], body: logBody, theme: 'striped', headStyles: { fillColor: [79, 70, 229] }, styles: { fontSize: 9 }, columnStyles: { 0: { cellWidth: 25 }, 1: { cellWidth: 35 } } });
                    y = doc.lastAutoTable.finalY + 15;
                }
            } else if (type === 'course') {
                doc.setFontSize(16); doc.text(`Informe de Curso: ${extraInfo}`, 15, y); y += 10;
                const total = data.length;
                const pieCount = data.filter(x=>x.isPIE).length;
                const closed = data.filter(x=>x.status==='Cerrado').length;
                
                doc.setFontSize(10);
                doc.text(`Total Casos: ${total}`, 15, y); doc.text(`Alumnos PIE: ${pieCount}`, 80, y); doc.text(`Cerrados: ${closed}`, 150, y); y += 10;
                
                const rows = data.map(d => [new Date(d.date).toLocaleDateString(), d.studentName, d.type || d.cause, d.isPIE?'SÍ':'NO', d.status || 'Abierto']);
                doc.autoTable({ startY: y, head: [['Fecha', 'Estudiante', 'Tipo', 'PIE', 'Estado']], body: rows, theme: 'grid', headStyles: { fillColor: [49, 46, 129] }, styles: { fontSize: 8 } });
                y = doc.lastAutoTable.finalY + 20;
            }

            const pageHeight = doc.internal.pageSize.height;
            doc.setDrawColor(200); doc.line(20, pageHeight - 30, pageWidth - 20, pageHeight - 30);
            doc.setFontSize(8); doc.setTextColor(150);
            doc.text(`${managerName} - Encargado de Convivencia Escolar`, pageWidth / 2, pageHeight - 20, { align: 'center' });
            doc.save(`${title.replace(/ /g, '_')}.pdf`);
        };

        const defaultConfig = {
            managerName: "Encargado Convivencia", 
            professionals: ["Psicólogo", "Orientador", "Inspector General", "Dupla Psicosocial"],
            caseTypes: ["Agresión Física", "Agresión Verbal", "Ciberacoso", "Disrupción Aula", "Inasistencia Grave", "Vulneración Derechos", "Problemas Académicos"],
            actions: ["Entrevista Apoderado", "Mediación Escolar", "Derivación Red Externa", "Suspensión", "Carta Compromiso", "Contención Emocional", "Visita Domiciliaria", "Entrevista Alumno"],
            courses: ["1° Básico", "2° Básico", "3° Básico", "4° Básico", "5° Básico", "6° Básico", "7° Básico", "8° Básico", "1° Medio", "2° Medio", "3° Medio", "4° Medio"],
            strategies: ["Diálogo formativo", "Cambio de puesto", "Citación Apoderado", "Refuerzo positivo", "Entrevista Alumno"]
        };

        // --- COMPONENTES ---

        const Modal = ({ children, onClose, title }) => (
            <div className="modal-overlay" onClick={onClose}>
                <div className="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto relative animate-fade-in flex flex-col" onClick={e=>e.stopPropagation()}>
                    <div className="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                        <h3 className="text-xl font-bold text-slate-800">{title}</h3>
                        <button onClick={onClose} className="text-slate-400 hover:text-rose-500 transition-colors"><Icon name="x" size={24}/></button>
                    </div>
                    <div className="p-6 overflow-y-auto">
                        {children}
                    </div>
                </div>
            </div>
        );

        const ReferralDetailModal = ({ data, onClose }) => (
            <Modal title={`Seguimiento: ${data.studentName}`} onClose={onClose}>
                <div className="space-y-8">
                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 flex flex-wrap gap-4 items-center justify-between">
                        <div><p className="text-xs font-bold text-slate-500 uppercase">Estado Actual</p><span className={`text-lg font-bold ${data.status==='Cerrado'?'text-emerald-600':'text-indigo-600'}`}>{data.status}</span></div>
                        <div><p className="text-xs font-bold text-slate-500 uppercase">Profesional</p><p className="font-medium text-slate-800">{data.professional || 'En asignación'}</p></div>
                        <div><p className="text-xs font-bold text-slate-500 uppercase">PIE / Redes</p><div className="flex gap-2 mt-1">{data.isPIE && <span className="text-[10px] bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded font-bold">PIE</span>}{data.hasExternalSupport && <span className="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-bold">Redes</span>}</div></div>
                    </div>
                    
                    <div>
                        <h4 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Icon name="clipboard-list" className="text-indigo-600"/> Historial de Gestión</h4>
                        <div className="relative border-l-2 border-slate-200 ml-3 space-y-6">
                            {(!data.interventions || data.interventions.length === 0) && (<div className="ml-6 text-sm text-slate-400 italic">Aún no hay registros de gestión en la bitácora.</div>)}
                            {(data.interventions || []).map((int, idx) => (
                                <div key={idx} className="ml-6 relative">
                                    <div className="absolute -left-[31px] top-0 w-4 h-4 rounded-full bg-indigo-600 border-2 border-white shadow-sm"></div>
                                    <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                                        <div className="flex justify-between items-start mb-2">
                                            <div><span className="text-xs font-bold text-indigo-600 uppercase tracking-wide">Gestión Realizada</span><p className="text-sm text-slate-500">{new Date(int.date).toLocaleDateString()}</p></div>
                                            <div className="bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded font-bold">{int.professional || 'Equipo Convivencia'}</div>
                                        </div>
                                        <p className="text-slate-700 text-sm leading-relaxed whitespace-pre-wrap">{int.content}</p>
                                        {/* Mostrar acciones asociadas a esta gestión */}
                                        {int.actions && int.actions.length > 0 && (
                                            <div className="mt-3 pt-3 border-t border-slate-100 flex flex-wrap gap-2">
                                                {int.actions.map((act, i) => <span key={i} className="text-xs bg-indigo-50 text-indigo-700 px-2 py-1 rounded border border-indigo-100 flex items-center gap-1"><Icon name="check" size={10}/> {act}</span>)}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </Modal>
        );

        // --- COMPONENTE DE CONFIGURACIÓN MODIFICADO ---
        const ConfigView = ({ config, users, onUpdateConf, onUpdateRole, onDeleteUser }) => {
            const Section = ({ k, title, icon }) => {
                const [v, setV] = useState('');
                const currentList = config[k] || [];
                const add = () => { if(v && !currentList.includes(v)){onUpdateConf({...config, [k]:[...currentList, v]}); setV('');}};
                return (
                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 className="font-bold mb-4 flex items-center gap-2 text-slate-700"><Icon name={icon} className="text-indigo-600"/> {title}</h3>
                        <div className="flex gap-2 mb-4">
                            <input className="flex-1 border p-2 rounded-lg bg-slate-50 outline-none focus:border-indigo-500 text-sm" placeholder="Añadir nuevo..." value={v} onChange={e=>setV(e.target.value)} />
                            <button onClick={add} className="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700"><Icon name="plus" size={18}/></button>
                        </div>
                        <div className="flex flex-wrap gap-2">
                            {currentList.map(x=><span key={x} className="bg-slate-100 px-3 py-1 rounded-full text-xs text-slate-600 cursor-pointer hover:bg-rose-100 hover:text-rose-600 transition-colors flex items-center gap-1" onClick={()=>onUpdateConf({...config, [k]:currentList.filter(i=>i!==x)})}>{x} <Icon name="x" size={10}/></span>)}
                        </div>
                    </div>
                );
            };
            return (
                <div className="fade-in max-w-5xl mx-auto space-y-8 pb-20">
                    <h2 className="text-2xl font-bold text-slate-800 mb-6">Configuración del Sistema</h2>
                    <div className="grid md:grid-cols-2 gap-6">
                         <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                            <h3 className="font-bold text-lg mb-6 flex items-center gap-2 text-indigo-700"><Icon name="users"/> Gestión de Usuarios</h3>
                            <div className="overflow-hidden rounded-xl border border-slate-200 max-h-60 overflow-y-auto">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-slate-50 text-slate-500 font-bold sticky top-0"><tr><th className="p-3">Usuario</th><th className="p-3">Rol</th><th className="p-3 text-right">Acción</th></tr></thead>
                                    <tbody className="divide-y divide-slate-100">{users.map(u => <tr key={u.id}>
                                        <td className="p-3 font-medium text-xs">{u.name}<br/><span className="text-gray-400">{u.email}</span></td>
                                        <td className="p-3"><span className={`px-2 py-0.5 rounded-full text-[10px] font-bold ${u.role==='admin'?'bg-indigo-100 text-indigo-700':'bg-emerald-100 text-emerald-700'}`}>{u.role}</span></td>
                                        <td className="p-3 text-right">
                                            <div className="flex justify-end gap-2">
                                                <button onClick={()=>onUpdateRole(u.id, u.role==='admin'?'funcionario':'admin')} className="text-indigo-600 hover:underline font-bold text-[10px]">Cambiar</button>
                                                <button onClick={()=>onDeleteUser(u.id)} className="text-rose-600 hover:underline font-bold text-[10px] flex items-center gap-1"><Icon name="trash-2" size={10}/> Eliminar</button>
                                            </div>
                                        </td>
                                    </tr>)}</tbody>
                                </table>
                            </div>
                        </div>

                        <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2 text-indigo-700"><Icon name="settings"/> Datos Institucionales</h3>
                            <div className="space-y-4">
                                <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Nombre Encargado Convivencia</label><input className="w-full p-3 border border-slate-200 rounded-xl bg-slate-50 outline-none focus:ring-2 focus:ring-indigo-500" value={config.managerName} onChange={e=>onUpdateConf({...config, managerName:e.target.value})} /></div>
                                <button className="w-full bg-indigo-600 text-white py-2 rounded-xl font-bold hover:bg-indigo-700 transition" onClick={()=>onUpdateConf(config)}>Guardar Cambios</button>
                            </div>
                        </div>
                    </div>
                    <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <Section k="courses" title="Cursos" icon="graduation-cap"/>
                        <Section k="professionals" title="Profesionales" icon="briefcase"/>
                        <Section k="caseTypes" title="Tipos de Faltas" icon="alert-octagon"/>
                        <Section k="actions" title="Acciones y Protocolos" icon="clipboard-list"/>
                        <Section k="strategies" title="Estrategias Previas" icon="lightbulb"/>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onAuth, error, loading }) => {
            const [isReg, setIsReg] = useState(false);
            const [creds, setCreds] = useState({email:'', pass:'', name:'', jobTitle:''});
            const [success, setSuccess] = useState(false);

            const handleAction = async () => {
                if(!creds.email || !creds.pass) return alert("Por favor complete todos los campos.");
                const res = await onAuth(creds, isReg);
                if(isReg && res) setSuccess(true);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 relative overflow-hidden">
                    <div className="absolute inset-0 bg-gradient-to-br from-blue-600 to-indigo-900 z-0"></div>
                    <div className="bg-white/95 backdrop-blur-xl p-8 rounded-3xl shadow-2xl w-full max-w-sm relative z-10 border border-white/50">
                        {loading && <div className="absolute inset-0 bg-white/80 flex items-center justify-center z-20 rounded-3xl flex-col gap-2"><div className="spinner"></div><span className="text-sm font-bold text-indigo-600">Verificando...</span></div>}
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-gradient-to-br from-indigo-500 to-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 text-white shadow-lg shadow-indigo-500/30"><Icon name="school" size={32}/></div>
                            <h2 className="text-2xl font-extrabold text-slate-800 tracking-tight">Convivencia Pro</h2>
                            <p className="text-sm text-slate-500 mt-1">Gestión Escolar Integral</p>
                        </div>
                        {success ? (
                            <div className="text-center py-4">
                                <div className="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4"><Icon name="check" size={32}/></div>
                                <h3 className="font-bold text-xl text-slate-800">¡Cuenta Creada!</h3>
                                <p className="text-slate-500 mb-6">Ya puedes acceder al sistema.</p>
                                <button onClick={()=>window.location.reload()} className="bg-slate-800 text-white w-full py-3 rounded-xl font-bold hover:bg-slate-900 transition-all">Iniciar Sesión</button>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                {isReg && (<><input className="w-full p-3 border border-slate-200 rounded-xl bg-slate-50 outline-none" type="text" placeholder="Nombre Completo" value={creds.name} onChange={e=>setCreds({...creds, name:e.target.value})} /><input className="w-full p-3 border border-slate-200 rounded-xl bg-slate-50 outline-none" type="text" placeholder="Cargo (Ej. Profesor Jefe)" value={creds.jobTitle} onChange={e=>setCreds({...creds, jobTitle:e.target.value})} /></>)}
                                <input className="w-full p-3 border border-slate-200 rounded-xl bg-slate-50 outline-none" type="email" placeholder="Correo institucional" value={creds.email} onChange={e=>setCreds({...creds, email:e.target.value})} />
                                <input className="w-full p-3 border border-slate-200 rounded-xl bg-slate-50 outline-none" type="password" placeholder="Contraseña" value={creds.pass} onChange={e=>setCreds({...creds, pass:e.target.value})} />
                                {error && <div className="bg-rose-50 text-rose-600 text-xs p-3 rounded-lg flex items-center gap-2 font-medium"><Icon name="alert-triangle" size={14}/> {error}</div>}
                                <button onClick={handleAction} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all transform active:scale-95">{isReg ? 'Registrar Funcionario' : 'Ingresar al Sistema'}</button>
                                <div className="text-center mt-4"><button onClick={()=>setIsReg(!isReg)} className="text-sm text-indigo-600 font-medium hover:underline">{isReg ? '¿Ya tienes cuenta? Ingresa aquí' : '¿No tienes cuenta? Regístrate'}</button></div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const CaseForm = ({ config, initialData, onSave, onCancel, isReferralView, userProfile }) => {
            const [d, setD] = useState(() => {
                const base = initialData || { 
                    studentName: '', course: config.courses[0], date: new Date().toISOString().split('T')[0], 
                    description: '', interventions: [], 
                    isPIE: false, hasExternalSupport: false, 
                    professional: config.professionals[0], type: config.caseTypes[0],
                    senderName: userProfile?.name, senderJob: userProfile?.jobTitle,
                    cause: config.caseTypes[0], appliedStrategies: []
                };
                return { ...base, interventions: base.interventions || [] };
            });

            const isManagingReferral = !isReferralView && d.isReferral;
            const [newInt, setNewInt] = useState({ date: new Date().toISOString().split('T')[0], content: "", actions: [] });

            const addInt = () => { 
                if(!newInt.content) return; 
                setD({...d, interventions: [{...newInt, professional: userProfile?.name || 'Encargado'}, ...d.interventions]}); 
                setNewInt({...newInt, content:'', actions: []}); 
            };

            const toggleIntAction = (act) => {
                const acts = newInt.actions || [];
                setNewInt({...newInt, actions: acts.includes(act) ? acts.filter(x=>x!==act) : [...acts, act]});
            };

            const handleCloseCase = () => { if(confirm("¿Estás seguro de cerrar este caso?")) { onSave({...d, status: 'Cerrado', closedAt: new Date().toISOString()}); } };

            return (
                <div className="max-w-4xl mx-auto pb-24 fade-in">
                    <div className="flex justify-between items-start mb-8">
                        <div>
                            <div className="flex items-center gap-3 mb-1"><button onClick={onCancel} className="text-slate-400 hover:text-slate-600"><Icon name="arrow-left"/></button><h2 className="text-2xl font-bold text-slate-800">{isReferralView ? "Nueva Derivación" : isManagingReferral ? "Gestionar Derivación" : "Registro Directo"}</h2></div>
                            <p className="text-slate-500 text-sm ml-9">{isReferralView ? "Complete los antecedentes para derivar el caso." : "Revise los antecedentes y registre la gestión."}</p>
                        </div>
                        <div className="flex gap-2">
                            {d.id && !isReferralView && d.status !== 'Cerrado' && (<button onClick={handleCloseCase} className="bg-emerald-100 text-emerald-700 px-4 py-2 rounded-lg font-bold hover:bg-emerald-200 transition-colors flex items-center gap-2"><Icon name="check-circle" size={18}/> Cerrar Caso</button>)}
                            <button onClick={onCancel} className="bg-white border border-slate-200 text-slate-600 px-4 py-2 rounded-lg font-bold hover:bg-slate-50 transition-colors">Cancelar</button>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2 space-y-6">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Icon name="user" className="text-indigo-600"/> Antecedentes del Estudiante</h3>
                                <div className="grid md:grid-cols-2 gap-4">
                                    <div><label className="text-xs font-bold text-slate-500 uppercase mb-1">Nombre Estudiante</label><input className={`w-full p-3 border rounded-xl outline-none ${isManagingReferral ? 'input-locked' : 'bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500'}`} value={d.studentName} onChange={e=>!isManagingReferral && setD({...d, studentName:e.target.value})} readOnly={isManagingReferral} placeholder="Nombre completo" /></div>
                                    <div><label className="text-xs font-bold text-slate-500 uppercase mb-1">Curso</label>{isManagingReferral ? (<input className="w-full p-3 border rounded-xl input-locked" value={d.course} readOnly />) : (<select className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" value={d.course} onChange={e=>setD({...d, course:e.target.value})}>{config.courses.map(c=><option key={c} value={c}>{c}</option>)}</select>)}</div>
                                    <div><label className="text-xs font-bold text-slate-500 uppercase mb-1">Fecha</label><input type="date" className={`w-full p-3 border rounded-xl outline-none ${isManagingReferral ? 'input-locked' : 'bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500'}`} value={d.date} onChange={e=>!isManagingReferral && setD({...d, date:e.target.value})} readOnly={isManagingReferral} /></div>
                                    <div><label className="text-xs font-bold text-slate-500 uppercase mb-1">{isReferralView || isManagingReferral ? 'Causa / Motivo' : 'Tipo de Falta'}</label>{isManagingReferral ? (<input className="w-full p-3 border rounded-xl input-locked" value={d.cause || d.type} readOnly />) : (<select className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" value={isReferralView ? d.cause : d.type} onChange={e=>setD({...d, [isReferralView?'cause':'type']:e.target.value})}>{config.caseTypes.map(c=><option key={c} value={c}>{c}</option>)}</select>)}</div>
                                </div>
                                <div className="mt-4"><label className="text-xs font-bold text-slate-500 uppercase mb-1">Relato de los Hechos</label><textarea className={`w-full p-4 border rounded-xl outline-none resize-none ${isManagingReferral ? 'input-locked' : 'bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500'}`} rows="4" value={d.description} onChange={e=>!isManagingReferral && setD({...d, description:e.target.value})} readOnly={isManagingReferral} placeholder="Describa la situación observada..."></textarea></div>
                                {(isReferralView || isManagingReferral) && (
                                    <div className="mt-4"><label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Estrategias Previas</label><div className="flex flex-wrap gap-2">{config.strategies.map(s => { const isActive = (d.appliedStrategies||[]).includes(s); if (isManagingReferral && !isActive) return null; return (<button key={s} disabled={isManagingReferral} onClick={()=>{ const list = d.appliedStrategies || []; setD({...d, appliedStrategies: list.includes(s) ? list.filter(x=>x!==s) : [...list, s]}); }} className={`px-3 py-1.5 rounded-lg text-xs font-bold border transition-all ${isActive ? 'bg-blue-50 border-blue-200 text-blue-700' : 'bg-white border-slate-200 text-slate-500'} ${isManagingReferral ? 'opacity-100 cursor-default' : 'hover:border-blue-300'}`}>{s}</button>)})}</div></div>
                                )}
                            </div>
                            {!isReferralView && (
                                <div className="bg-indigo-50/50 p-6 rounded-2xl shadow-sm border border-indigo-100">
                                    <h3 className="font-bold text-indigo-900 mb-4 flex items-center gap-2"><Icon name="briefcase" className="text-indigo-600"/> Gestión Profesional Convivencia</h3>
                                    <div className="grid md:grid-cols-2 gap-4 mb-4">
                                        <div><label className="text-xs font-bold text-slate-500 uppercase mb-1">Tipificación Oficial</label><select className="w-full p-2 bg-white border border-indigo-200 rounded-lg outline-none" value={d.type} onChange={e=>setD({...d, type:e.target.value})}>{config.caseTypes.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                        <div className="md:col-span-1"><label className="text-xs font-bold text-slate-500 uppercase mb-1">Profesional a Cargo</label><select className="w-full p-2 bg-white border border-indigo-200 rounded-lg outline-none" value={d.professional} onChange={e=>setD({...d, professional:e.target.value})}><option value="">Seleccionar...</option>{config.professionals.map(p=><option key={p} value={p}>{p}</option>)}</select></div>
                                    </div>
                                    <div className="flex flex-col md:flex-row gap-4 pt-2 border-t border-indigo-100">
                                        <div className="flex items-center gap-3 bg-white p-3 rounded-xl border border-indigo-100 flex-1">
                                            <div className={`w-10 h-6 rounded-full p-1 cursor-pointer transition-colors ${d.isPIE ? 'bg-indigo-600' : 'bg-slate-300'}`} onClick={()=>setD({...d, isPIE:!d.isPIE})}>
                                                <div className={`bg-white w-4 h-4 rounded-full shadow-md transform transition-transform ${d.isPIE ? 'translate-x-4' : ''}`}></div>
                                            </div>
                                            <span className="text-sm font-bold text-slate-700">Estudiante PIE</span>
                                        </div>
                                        <div className="flex items-center gap-3 bg-white p-3 rounded-xl border border-indigo-100 flex-1">
                                            <div className={`w-10 h-6 rounded-full p-1 cursor-pointer transition-colors ${d.hasExternalSupport ? 'bg-blue-600' : 'bg-slate-300'}`} onClick={()=>setD({...d, hasExternalSupport:!d.hasExternalSupport})}>
                                                <div className={`bg-white w-4 h-4 rounded-full shadow-md transform transition-transform ${d.hasExternalSupport ? 'translate-x-4' : ''}`}></div>
                                            </div>
                                            <span className="text-sm font-bold text-slate-700">Apoyo Redes Externas</span>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                        <div className="space-y-6">
                            {d.senderName && (
                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 relative overflow-hidden">
                                    <div className="absolute top-0 right-0 w-16 h-16 bg-blue-50 rounded-bl-full -mr-8 -mt-8"></div>
                                    <h4 className="text-xs font-bold text-slate-400 uppercase mb-3 relative z-10">Solicitante del Caso</h4>
                                    <div className="flex items-center gap-3 relative z-10">
                                        <div className="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-lg">{d.senderName.charAt(0)}</div>
                                        <div><p className="font-bold text-slate-800 text-sm">{d.senderName}</p><p className="text-xs text-slate-500 bg-slate-100 px-2 py-0.5 rounded-full inline-block mt-0.5">{d.senderJob}</p></div>
                                    </div>
                                </div>
                            )}
                            {!isReferralView && (
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[700px]">
                                    <div className="p-4 bg-slate-50 border-b border-slate-200"><h3 className="font-bold text-slate-800 flex items-center gap-2"><Icon name="clipboard-list"/> Bitácora de Gestión</h3></div>
                                    <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/50">
                                        {(!d.interventions || d.interventions.length === 0) && <p className="text-center text-sm text-slate-400 italic mt-10">No hay registros.</p>}
                                        {(d.interventions || []).map((int, i) => (
                                            <div key={i} className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm text-sm">
                                                <div className="flex justify-between items-center mb-1"><span className="font-bold text-indigo-600 text-xs">{new Date(int.date).toLocaleDateString()}</span><span className="text-[10px] bg-slate-100 px-2 py-0.5 rounded-full text-slate-500 font-bold">{int.professional}</span></div>
                                                <p className="text-slate-700 mb-2">{int.content}</p>
                                                {int.actions && int.actions.length > 0 && (
                                                    <div className="flex flex-wrap gap-1 mt-2 border-t pt-2 border-slate-50">
                                                        {int.actions.map(act=><span key={act} className="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded border border-indigo-100 font-medium">{act}</span>)}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                    <div className="p-4 bg-white border-t border-slate-200 flex flex-col gap-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                                        <div className="flex gap-2">
                                            <input type="date" className="w-1/3 text-xs p-2 border rounded-lg bg-slate-50" value={newInt.date} onChange={e=>setNewInt({...newInt, date:e.target.value})} />
                                            <span className="text-xs font-bold text-slate-400 flex items-center">Nueva Entrada</span>
                                        </div>
                                        <textarea className="w-full text-sm p-3 border rounded-lg bg-slate-50 focus:bg-white outline-none resize-none" rows="2" placeholder="Describa la gestión, acuerdo o reunión..." value={newInt.content} onChange={e=>setNewInt({...newInt, content:e.target.value})}></textarea>
                                        <div className="bg-slate-50 p-2 rounded-lg border border-slate-100">
                                            <p className="text-[10px] font-bold text-slate-400 uppercase mb-2">Protocolos / Acciones Realizadas:</p>
                                            <div className="grid grid-cols-2 gap-1.5 max-h-24 overflow-y-auto">
                                                {config.actions.map(a => (
                                                    <button key={a} onClick={()=>toggleIntAction(a)} className={`text-[10px] px-2 py-1.5 rounded text-left truncate transition-colors ${(newInt.actions||[]).includes(a) ? 'bg-indigo-600 text-white shadow-sm' : 'bg-white border border-slate-200 text-slate-500 hover:bg-indigo-50'}`}>
                                                        {a}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                        <button onClick={addInt} className="w-full bg-indigo-600 text-white py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 transition-colors flex justify-center items-center gap-2"><Icon name="plus-circle" size={16}/> Registrar Gestión</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                    <div className="hidden md:flex justify-end mt-6"><button onClick={()=>onSave(d)} className="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:shadow-xl transition-all flex items-center gap-2 transform active:scale-95"><Icon name="save" size={20}/> Guardar {isReferralView ? "Derivación" : "Gestión"}</button></div>
                </div>
            );
        };

        const MyReferralsList = ({ items, onOpen }) => (
            <div className="fade-in max-w-5xl mx-auto">
                <div className="flex justify-between items-end mb-6"><div><h2 className="text-3xl font-bold text-slate-800 tracking-tight">Mis Derivaciones</h2><p className="text-slate-500 mt-1">Historial de casos enviados a Convivencia Escolar</p></div></div>
                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <table className="w-full text-sm text-left">
                        <thead className="bg-slate-50 border-b border-slate-200 text-slate-500 font-bold uppercase text-xs tracking-wider"><tr><th className="p-5">Fecha</th><th className="p-5">Estudiante</th><th className="p-5">Causa / Ámbito</th><th className="p-5">Estado</th><th className="p-5 text-center">Novedades</th><th className="p-5 text-right">Acciones</th></tr></thead>
                        <tbody className="divide-y divide-slate-100">
                            {items.map(r => {
                                const hasNews = r.interventions && r.interventions.length > 0 && r.status !== 'Cerrado';
                                return (
                                <tr key={r.id} className="hover:bg-slate-50 transition-colors group">
                                    <td className="p-5 font-medium text-slate-600">{new Date(r.date).toLocaleDateString()}</td>
                                    <td className="p-5"><div className="font-bold text-slate-800">{r.studentName}</div><div className="text-xs text-slate-500">{r.course}</div></td>
                                    <td className="p-5"><span className="bg-slate-100 text-slate-600 px-2 py-1 rounded-md text-xs font-medium">{r.cause || 'No especificado'}</span></td>
                                    <td className="p-5"><span className={`badge ${r.status==='Cerrado'?'badge-closed':r.status==='Pendiente'?'badge-pending':'badge-active'}`}>{r.status || 'Pendiente'}</span></td>
                                    <td className="p-5 text-center">{hasNews && <span className="inline-flex items-center gap-1 bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full text-xs font-bold animate-pulse"><Icon name="bell" size={12}/> Actividad</span>}</td>
                                    <td className="p-5 text-right"><button onClick={()=>onOpen(r)} className="text-indigo-600 hover:text-indigo-800 font-medium text-sm flex items-center gap-1 ml-auto hover:bg-indigo-50 px-3 py-1.5 rounded-lg transition-colors"><Icon name="eye" size={16}/> Ver Detalle</button></td>
                                </tr>
                                );
                            })}
                        </tbody>
                    </table>
                    {items.length === 0 && <div className="p-12 text-center text-slate-400 italic">No has realizado derivaciones aún.</div>}
                </div>
            </div>
        );

        const Dashboard = ({ cases, onEdit, onDelete, onPrint }) => {
            const stats = useMemo(() => {
                const total = cases.length; 
                // Cambio Riesgo por PIE
                const pieCount = cases.filter(c => c.isPIE).length; 
                const open = cases.filter(c => c.status !== 'Cerrado').length;
                return { total, pieCount, open };
            }, [cases]);

            return (
                <div className="fade-in space-y-8">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4 card-hover"><div className="p-4 bg-blue-50 text-blue-600 rounded-xl"><Icon name="folder-open" size={28}/></div><div><p className="text-xs font-bold text-slate-400 uppercase tracking-wide">Total Casos</p><h3 className="text-3xl font-bold text-slate-800">{stats.total}</h3></div></div>
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4 card-hover"><div className="p-4 bg-indigo-50 text-indigo-600 rounded-xl"><Icon name="users" size={28}/></div><div><p className="text-xs font-bold text-slate-400 uppercase tracking-wide">Estudiantes PIE</p><h3 className="text-3xl font-bold text-slate-800">{stats.pieCount}</h3></div></div>
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4 card-hover"><div className="p-4 bg-emerald-50 text-emerald-600 rounded-xl"><Icon name="activity" size={28}/></div><div><p className="text-xs font-bold text-slate-400 uppercase tracking-wide">En Gestión</p><h3 className="text-3xl font-bold text-slate-800">{stats.open}</h3></div></div>
                    </div>
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="p-6 border-b border-slate-100 flex justify-between items-center"><h3 className="font-bold text-slate-800 text-lg">Casos Recientes</h3></div>
                        <div className="overflow-x-auto"><table className="w-full text-sm text-left"><thead className="bg-slate-50 text-slate-500 font-bold uppercase text-xs"><tr><th className="p-4">Estudiante</th><th className="p-4">Tipo/Causa</th><th className="p-4">PIE</th><th className="p-4">Estado</th><th className="p-4 text-right">Acciones</th></tr></thead><tbody className="divide-y divide-slate-100">{cases.slice(0, 10).map(c => (<tr key={c.id} className="hover:bg-slate-50 transition-colors"><td className="p-4 font-bold text-slate-700">{c.studentName}<br/><span className="text-xs font-normal text-slate-500">{c.course}</span></td><td className="p-4">{c.type || c.cause}</td><td className="p-4">{c.isPIE ? <span className="badge badge-pie">PIE</span> : <span className="text-slate-400">-</span>}</td><td className="p-4"><span className={`badge ${c.status==='Cerrado'?'badge-closed':'badge-active'}`}>{c.status||'Abierto'}</span></td><td className="p-4 flex justify-end gap-2"><button onClick={()=>onPrint("Ficha Caso", c, 'single')} className="p-2 text-slate-400 hover:text-indigo-600 rounded-lg" title="PDF"><Icon name="printer"/></button><button onClick={()=>onEdit(c)} className="p-2 text-slate-400 hover:text-indigo-600 rounded-lg" title="Gestionar"><Icon name="edit-3"/></button><button onClick={()=>onDelete(c.id)} className="p-2 text-slate-400 hover:text-rose-600 rounded-lg" title="Eliminar"><Icon name="trash-2"/></button></td></tr>))}</tbody></table></div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [userProfile, setProfile] = useState(null);
            const [role, setRole] = useState('funcionario');
            const [view, setView] = useState('dashboard');
            // CORRECCIÓN: Inicializar myReferrals para evitar "undefined"
            const [data, setData] = useState({ cases: [], referrals: [], users: [], myReferrals: [] });
            const [config, setConfig] = useState(defaultConfig);
            const [editing, setEditing] = useState(null);
            const [viewingRef, setViewingRef] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (u) => {
                    if (u) {
                        setUser(u);
                        const uRef = db.collection('users').doc(u.email);
                        let docSnap = await uRef.get();
                        if (!docSnap.exists) { await uRef.set({ email: u.email, role: 'funcionario', name: 'Usuario', jobTitle: 'Funcionario' }); docSnap = await uRef.get(); }
                        const p = docSnap.data(); setProfile(p); setRole(p.role);

                        db.collection('cases').onSnapshot(s => {
                            const all = s.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b) => new Date(b.date)-new Date(a.date));
                            setData(prev => ({ ...prev, cases: all, referrals: all.filter(x => x.isReferral && x.status === 'Pendiente'), myReferrals: all.filter(x => x.createdBy === u.email) }));
                        });
                        db.collection('config').doc('main').onSnapshot(s => { if(s.exists) setConfig({...defaultConfig, ...s.data()}); });
                        db.collection('users').onSnapshot(s => setData(prev => ({...prev, users: s.docs.map(d => ({id:d.id, ...d.data()}))})));
                        setLoading(false); setView(p.role === 'admin' ? 'dashboard' : 'my_referrals');
                    } else { setUser(null); setLoading(false); }
                });
                return () => unsubscribe();
            }, []);

            const handleAuth = async (d, isReg) => {
                setLoading(true);
                try {
                    if(isReg) { const { user: u } = await auth.createUserWithEmailAndPassword(d.email, d.pass); const usersSnap = await db.collection('users').get(); await db.collection('users').doc(u.email).set({ email: d.email, name: d.name, jobTitle: d.jobTitle, role: usersSnap.empty?'admin':'funcionario' }); return true; } 
                    else { await auth.signInWithEmailAndPassword(d.email, d.pass); }
                } catch(e) { alert(e.message); setLoading(false); }
            };

            const handleSave = async (d) => {
                // CORRECCIÓN: Verificación segura de userProfile
                if(!userProfile) return alert("Error de sesión. Recargue la página.");
                
                const final = { ...d, updatedBy: user.email, updatedAt: new Date().toISOString() };
                if (!d.createdAt) { 
                    final.createdAt = new Date().toISOString(); final.createdBy = user.email;
                    if(d.isReferral) { final.senderName = userProfile.name; final.senderJob = userProfile.jobTitle; }
                }
                try { if(editing && editing.id) await db.collection('cases').doc(editing.id).update(final); else await db.collection('cases').add(final); setEditing(null); setView(role==='admin' ? 'dashboard' : 'my_referrals'); } catch(e) { alert("Error al guardar: " + e.message); }
            };

            const handleDelete = async (id) => { if(confirm("¿Eliminar registro?")) await db.collection('cases').doc(id).delete(); };
            
            // NUEVA FUNCIÓN PARA ELIMINAR USUARIOS
            const handleDeleteUser = async (id) => {
                if(confirm("¿Estás seguro de eliminar este usuario del sistema? Se eliminarán sus permisos de acceso.")) {
                    try {
                        await db.collection('users').doc(id).delete();
                    } catch (e) {
                        alert("Error al eliminar usuario: " + e.message);
                    }
                }
            };

            const handleUpdateRole = async (id, r) => { await db.collection('users').doc(id).update({role: r}); };
            const handleUpdateConf = async (c) => { await db.collection('config').doc('main').set(c, {merge:true}); };

            if(loading) return <div style={{height:'100vh', display:'flex', justifyContent:'center', alignItems:'center'}}><div className="spinner"></div></div>;
            if(!user) return <LoginScreen onAuth={handleAuth} loading={loading} />;
            const isAdmin = role === 'admin';

            return (
                <div className="flex h-screen bg-slate-50">
                    <aside className="w-72 gradient-sidebar text-white hidden md:flex flex-col shadow-2xl z-20">
                        <div className="p-8 border-b border-indigo-400/30">
                            <div className="flex items-center gap-3"><div className="bg-white/10 p-2 rounded-lg"><Icon name="shield" size={24}/></div><div><h1 className="font-bold text-lg leading-tight">Convivencia Pro</h1><p className="text-[10px] text-indigo-200 uppercase tracking-widest mt-1">{isAdmin?'Administración':'Docentes'}</p></div></div>
                        </div>
                        <div className="p-6">
                            <div className="bg-black/20 rounded-xl p-4 mb-6 backdrop-blur-sm border border-white/5">
                                <p className="text-xs text-indigo-200 uppercase font-bold mb-1">Usuario Activo</p>
                                <p className="font-bold truncate">{userProfile?.name}</p>
                                <p className="text-xs text-indigo-300 truncate">{userProfile?.jobTitle}</p>
                            </div>
                            <nav className="space-y-2">
                                {isAdmin ? (
                                    <>
                                        <MenuBtn active={view==='dashboard'} onClick={()=>setView('dashboard')} icon="layout-dashboard" label="Panel General" />
                                        <MenuBtn active={view==='inbox'} onClick={()=>setView('inbox')} icon="inbox" label="Bandeja Entrada" badge={data.referrals.length} />
                                        <MenuBtn active={view==='register'} onClick={()=>{setEditing({isReferral:false}); setView('register');}} icon="plus-circle" label="Registro Directo" />
                                        <MenuBtn active={view==='reports'} onClick={()=>setView('reports')} icon="file-text" label="Reportes PDF" />
                                        <MenuBtn active={view==='config'} onClick={()=>setView('config')} icon="settings" label="Configuración" />
                                    </>
                                ) : (
                                    <>
                                        <MenuBtn active={view==='referral'} onClick={()=>{setEditing({isReferral:true}); setView('referral');}} icon="send" label="Nueva Derivación" />
                                        <MenuBtn active={view==='my_referrals'} onClick={()=>setView('my_referrals')} icon="list" label="Mis Derivaciones" />
                                    </>
                                )}
                            </nav>
                        </div>
                        <button onClick={()=>auth.signOut()} className="mt-auto p-6 flex items-center gap-3 text-indigo-200 hover:text-white hover:bg-white/5 transition-colors text-sm font-medium border-t border-indigo-400/30"><Icon name="log-out" size={18}/> Cerrar Sesión</button>
                    </aside>

                    <main className="flex-1 overflow-y-auto relative">
                        <div className="md:hidden bg-indigo-900 text-white p-4 flex justify-between items-center sticky top-0 z-50"><span className="font-bold">Convivencia Pro</span><button onClick={()=>auth.signOut()}><Icon name="log-out"/></button></div>
                        <div className="p-4 md:p-10 max-w-7xl mx-auto">
                            {isAdmin && view==='dashboard' && <Dashboard cases={data.cases} onEdit={c=>{setEditing(c); setView('register');}} onDelete={handleDelete} onPrint={(t,d,ty)=>generatePDF(t,d,ty,'',config.managerName)} />}
                            
                            {isAdmin && view==='inbox' && (
                                <div className="fade-in">
                                    <h2 className="text-2xl font-bold text-slate-800 mb-6">Bandeja de Derivaciones</h2>
                                    <div className="grid gap-4">
                                        {data.referrals.length===0 && <div className="p-12 text-center border-2 border-dashed border-slate-300 rounded-2xl text-slate-400">No hay derivaciones pendientes de revisión.</div>}
                                        {data.referrals.map(r => (
                                            <div key={r.id} className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:border-indigo-400 transition-all group cursor-pointer" onClick={()=>{setEditing(r); setView('register');}}>
                                                <div className="flex justify-between items-start mb-3"><div className="flex items-center gap-3"><div className="w-2 h-12 bg-amber-500 rounded-full"></div><div><h3 className="font-bold text-lg text-slate-800">{r.studentName}</h3><p className="text-sm text-slate-500">{r.course} • Enviado por {r.senderName}</p></div></div><span className="badge badge-pending">Revisión Pendiente</span></div>
                                                <div className="bg-slate-50 p-3 rounded-lg text-sm text-slate-600 mb-4 line-clamp-2">"{r.description}"</div>
                                                <button className="text-indigo-600 font-bold text-sm hover:underline flex items-center gap-1">Gestionar Caso <Icon name="arrow-right" size={16}/></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {(view==='register' || view==='referral') && <CaseForm config={config} initialData={editing} onSave={d=>handleSave({...d, status: d.status || (view==='referral'?'Pendiente':'Abierto')})} onCancel={()=>setView(isAdmin?'dashboard':'my_referrals')} isReferralView={view === 'referral'} userProfile={userProfile} />}

                            {isAdmin && view==='reports' && (
                                <div className="fade-in max-w-2xl mx-auto mt-10">
                                    <div className="bg-white p-8 rounded-2xl shadow-lg border border-slate-200">
                                        <div className="text-center mb-8"><div className="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4"><Icon name="file-text" size={32}/></div><h2 className="text-2xl font-bold text-slate-800">Centro de Reportes</h2><p className="text-slate-500">Generación de informes oficiales</p></div>
                                        <div className="space-y-6"><div><label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Informe por Curso</label><div className="flex gap-2"><select id="repCourse" className="flex-1 p-3 border rounded-xl bg-slate-50">{config.courses.map(c=><option key={c} value={c}>{c}</option>)}</select><button onClick={()=>{const c = document.getElementById('repCourse').value; const filter = data.cases.filter(x=>x.course===c); generatePDF(`Informe Situacional ${c}`, filter, 'course', c, config.managerName);}} className="bg-indigo-600 text-white px-6 rounded-xl font-bold hover:bg-indigo-700">Descargar PDF</button></div></div></div>
                                    </div>
                                </div>
                            )}

                            {isAdmin && view==='config' && <ConfigView config={config} users={data.users} onUpdateConf={handleUpdateConf} onUpdateRole={handleUpdateRole} onDeleteUser={handleDeleteUser} />}

                            {!isAdmin && view==='my_referrals' && <MyReferralsList items={data.myReferrals || []} onOpen={setViewingRef} />}
                            
                            {/* CORRECCIÓN: Uso limpio del componente Modal Detalle */}
                            {viewingRef && <ReferralDetailModal data={viewingRef} onClose={()=>setViewingRef(null)} />}
                        </div>
                    </main>
                </div>
            );
        };

        const MenuBtn = ({ active, onClick, icon, label, badge }) => (
            <button onClick={onClick} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group mb-1 ${active ? 'bg-white/10 text-white font-bold shadow-inner' : 'text-indigo-200 hover:bg-white/5 hover:text-white'}`}>
                <Icon name={icon} size={20} className={active ? 'text-white' : 'text-indigo-300 group-hover:text-white'}/>
                <span className="flex-1 text-left">{label}</span>
                {badge > 0 && <span className="bg-rose-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm">{badge}</span>}
            </button>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

